(function(){"use strict";let i,w=null;function b(){return(w===null||w.byteLength===0)&&(w=new Uint8Array(i.memory.buffer)),w}let h=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});h.decode();const I=2146435072;let E=0;function M(e,t){return E+=t,E>=I&&(h=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),h.decode(),E=t),h.decode(b().subarray(e,e+t))}function g(e,t){return e=e>>>0,M(e,t)}function B(e,t){return e=e>>>0,b().subarray(e/1,e/1+t)}let f=0;const p=new TextEncoder;"encodeInto"in p||(p.encodeInto=function(e,t){const n=p.encode(e);return t.set(n),{read:e.length,written:n.length}});function A(e,t,n){if(n===void 0){const l=p.encode(e),d=t(l.length,1)>>>0;return b().subarray(d,d+l.length).set(l),f=l.length,d}let r=e.length,s=t(r,1)>>>0;const o=b();let a=0;for(;a<r;a++){const l=e.charCodeAt(a);if(l>127)break;o[s+a]=l}if(a!==r){a!==0&&(e=e.slice(a)),s=n(s,r,r=a+e.length*3,1)>>>0;const l=b().subarray(s+a,s+r),d=p.encodeInto(e,l);a+=d.written,s=n(s,r,a,1)>>>0}return f=a,s}let _=null;function R(){return(_===null||_.buffer.detached===!0||_.buffer.detached===void 0&&_.buffer!==i.memory.buffer)&&(_=new DataView(i.memory.buffer)),_}function x(e){const t=i.__wbindgen_export_3.get(e);return i.__externref_table_dealloc(e),t}function D(e){let t,n;try{const r=A(e,i.__wbindgen_malloc,i.__wbindgen_realloc),s=f,o=i.guess_mime_type(r,s);return t=o[0],n=o[1],g(o[0],o[1])}finally{i.__wbindgen_free(t,n,1)}}function L(e,t){const n=t(e.length*1,1)>>>0;return b().set(e,n/1),f=e.length,n}function O(e){const t=L(e,i.__wbindgen_malloc),n=f,r=i.load_epub(t,n);if(r[2])throw x(r[1]);return y.__wrap(r[0])}const W=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_epubctxt_free(e>>>0,1));class y{static __wrap(t){t=t>>>0;const n=Object.create(y.prototype);return n.__wbg_ptr=t,W.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,W.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_epubctxt_free(t,0)}metadata(){let t,n;try{const r=i.epubctxt_metadata(this.__wbg_ptr);return t=r[0],n=r[1],g(r[0],r[1])}finally{i.__wbindgen_free(t,n,1)}}read_file(t){const n=A(t,i.__wbindgen_malloc,i.__wbindgen_realloc),r=f,s=i.epubctxt_read_file(this.__wbg_ptr,n,r);if(s[2])throw x(s[1]);return x(s[0])}}Symbol.dispose&&(y.prototype[Symbol.dispose]=y.prototype.free);const q=new Set(["basic","cors","default"]);async function C(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.ok&&q.has(e.type)&&e.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function F(){const e={};return e.wbg={},e.wbg.__wbg_Error_e17e777aac105295=function(t,n){return Error(g(t,n))},e.wbg.__wbg_error_7534b8e9a36f1ab4=function(t,n){let r,s;try{r=t,s=n,console.error(g(t,n))}finally{i.__wbindgen_free(r,s,1)}},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},e.wbg.__wbg_newfromslice_074c56947bd43469=function(t,n){return new Uint8Array(B(t,n))},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(t,n){const r=n.stack,s=A(r,i.__wbindgen_malloc,i.__wbindgen_realloc),o=f;R().setInt32(t+4,o,!0),R().setInt32(t+0,s,!0)},e.wbg.__wbg_wbindgenthrow_451ec1a8469d7eb6=function(t,n){throw new Error(g(t,n))},e.wbg.__wbindgen_init_externref_table=function(){const t=i.__wbindgen_export_3,n=t.grow(4);t.set(0,void 0),t.set(n+0,void 0),t.set(n+1,null),t.set(n+2,!0),t.set(n+3,!1)},e}function P(e,t){return i=e.exports,S.__wbindgen_wasm_module=t,_=null,w=null,i.__wbindgen_start(),i}async function S(e){if(i!==void 0)return i;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL(""+new URL("assets/rs_utils_bg-D7UhxRIs.wasm",self.location.href).href,self.location.href));const t=F();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await C(await e,t);return P(n,r)}let u=self,m,T,k=new BroadcastChannel("log-channel"),c=(...e)=>k.postMessage(e.map(t=>t.toString()).join("	"));u.addEventListener("install",e=>{async function t(){c("Installed"),u.skipWaiting(),await S(),c("Initialized")}e.waitUntil(t())}),u.addEventListener("activate",e=>{async function t(){c("Activated"),await u.clients.claim(),c("Claimed")}e.waitUntil(t())}),u.addEventListener("fetch",e=>{if(!m){c("Ignoring request due to no loaded EPUB");return}if(!T){c("Ignoring request due to no current scope");return}let n=T+"bene-reader/epub-content/";if(e.request.url.startsWith(n)){let r=e.request.url.slice(n.length);r=r.split("#")[0];let s=m.read_file(r),o=D(r);e.respondWith(new Response(s,{status:200,headers:{"Content-Type":o}})),c("Handling request for",e.request.url,"with guessed type",o)}else c("Ignoring request for",e.request.url)}),u.addEventListener("message",e=>{async function t(){let n=e.data;if(n.type==="new-epub"){let{data:r,scope:s,url:o,path:a}=n.data;c("Attempting to load new epub"),await S();try{m=O(r)}catch(U){c("Failed to load EPUB with error: ",U);return}T=s;let l=JSON.parse(m.metadata()),d=await u.clients.matchAll();c("Loaded new epub, broadcasting to window");for(let U of d){let v={type:"loaded-epub",data:{metadata:l,url:o,path:a}};U.postMessage(v)}}}e.waitUntil(t())})})();
