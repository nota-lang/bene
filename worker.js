(function(){"use strict";let a;const l=new Array(128).fill(void 0);l.push(void 0,null,!0,!1);function g(e){return l[e]}let p=l.length;function M(e){e<132||(l[e]=p,p=e)}function y(e){const t=g(e);return M(e),t}const U=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&U.decode();let h=null;function m(){return(h===null||h.byteLength===0)&&(h=new Uint8Array(a.memory.buffer)),h}function v(e,t){return e=e>>>0,U.decode(m().subarray(e,e+t))}function b(e){p===l.length&&l.push(l.length+1);const t=p;return p=l[t],l[t]=e,t}let A=null;function c(){return(A===null||A.byteLength===0)&&(A=new Int32Array(a.memory.buffer)),A}let f=0;const E=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},S=typeof E.encodeInto=="function"?function(e,t){return E.encodeInto(e,t)}:function(e,t){const n=E.encode(e);return t.set(n),{read:e.length,written:n.length}};function k(e,t,n){if(n===void 0){const _=E.encode(e),u=t(_.length,1)>>>0;return m().subarray(u,u+_.length).set(_),f=_.length,u}let r=e.length,o=t(r,1)>>>0;const i=m();let s=0;for(;s<r;s++){const _=e.charCodeAt(s);if(_>127)break;i[o+s]=_}if(s!==r){s!==0&&(e=e.slice(s)),o=n(o,r,r=s+e.length*3,1)>>>0;const _=m().subarray(o+s,o+r),u=S(e,_);s+=u.written}return f=s,o}function I(){try{const n=a.__wbindgen_add_to_stack_pointer(-16);a.init_rs(n);var e=c()[n/4+0],t=c()[n/4+1];if(t)throw y(e)}finally{a.__wbindgen_add_to_stack_pointer(16)}}function R(e,t){const n=t(e.length*1,1)>>>0;return m().set(e,n/1),f=e.length,n}function C(e){try{const o=a.__wbindgen_add_to_stack_pointer(-16),i=R(e,a.__wbindgen_malloc),s=f;a.load_epub(o,i,s);var t=c()[o/4+0],n=c()[o/4+1],r=c()[o/4+2];if(r)throw y(n);return W.__wrap(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}function O(e){let t,n;try{const i=a.__wbindgen_add_to_stack_pointer(-16),s=k(e,a.__wbindgen_malloc,a.__wbindgen_realloc),_=f;a.guess_mime_type(i,s,_);var r=c()[i/4+0],o=c()[i/4+1];return t=r,n=o,v(r,o)}finally{a.__wbindgen_add_to_stack_pointer(16),a.__wbindgen_free(t,n,1)}}class W{static __wrap(t){t=t>>>0;const n=Object.create(W.prototype);return n.__wbg_ptr=t,n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();a.__wbg_epubctxt_free(t)}metadata(){let t,n;try{const i=a.__wbindgen_add_to_stack_pointer(-16);a.epubctxt_metadata(i,this.__wbg_ptr);var r=c()[i/4+0],o=c()[i/4+1];return t=r,n=o,v(r,o)}finally{a.__wbindgen_add_to_stack_pointer(16),a.__wbindgen_free(t,n,1)}}read_file(t){try{const i=a.__wbindgen_add_to_stack_pointer(-16),s=k(t,a.__wbindgen_malloc,a.__wbindgen_realloc),_=f;a.epubctxt_read_file(i,this.__wbg_ptr,s,_);var n=c()[i/4+0],r=c()[i/4+1],o=c()[i/4+2];if(o)throw y(r);return y(n)}finally{a.__wbindgen_add_to_stack_pointer(16)}}}async function j(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function q(){const e={};return e.wbg={},e.wbg.__wbindgen_object_drop_ref=function(t){y(t)},e.wbg.__wbindgen_error_new=function(t,n){const r=new Error(v(t,n));return b(r)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){const t=new Error;return b(t)},e.wbg.__wbg_stack_658279fe44541cf6=function(t,n){const r=g(n).stack,o=k(r,a.__wbindgen_malloc,a.__wbindgen_realloc),i=f;c()[t/4+1]=i,c()[t/4+0]=o},e.wbg.__wbg_error_f851667af71bcfc6=function(t,n){let r,o;try{r=t,o=n,console.error(v(t,n))}finally{a.__wbindgen_free(r,o,1)}},e.wbg.__wbg_buffer_a448f833075b71ba=function(t){const n=g(t).buffer;return b(n)},e.wbg.__wbg_newwithbyteoffsetandlength_d0482f893617af71=function(t,n,r){const o=new Uint8Array(g(t),n>>>0,r>>>0);return b(o)},e.wbg.__wbg_new_8f67e318f15d7254=function(t){const n=new Uint8Array(g(t));return b(n)},e.wbg.__wbindgen_throw=function(t,n){throw new Error(v(t,n))},e.wbg.__wbindgen_memory=function(){const t=a.memory;return b(t)},e}function B(e,t){return a=e.exports,L.__wbindgen_wasm_module=t,A=null,h=null,a}async function L(e){if(a!==void 0)return a;typeof e>"u"&&(e=new URL(""+new URL("assets/rs_utils_bg-Dl1_s9UL.wasm",self.location.href).href,self.location.href));const t=q();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await j(await e,t);return B(n,r)}let d=self,T,x,D=new BroadcastChannel("install-channel"),P=new BroadcastChannel("log-channel"),w=(...e)=>P.postMessage(e.map(t=>t.toString()).join("	"));d.addEventListener("install",async e=>{w("Installed"),await Promise.all([d.skipWaiting(),L()]),I(),w("Initialized"),D.postMessage("installed")}),d.addEventListener("activate",async e=>{w("Activated"),await d.clients.claim(),w("Claimed")}),d.addEventListener("fetch",e=>{if(!T||!x)return;let n=x+"bene-reader/epub-content/";if(e.request.url.startsWith(n)){let r=e.request.url.slice(n.length);r=r.split("#")[0];let o=T.read_file(r),i=O(r);e.respondWith(new Response(o,{status:200,headers:{"Content-Type":i}})),w("Handling request for",e.request.url,"with guessed type",i)}else w("Ignoring request for",e.request.url)}),d.addEventListener("message",async e=>{let t=e.data;if(t.type=="new-epub"){let{data:n,scope:r,url:o,path:i}=t.data;T=C(n),x=r;let s=JSON.parse(T.metadata()),_=await d.clients.matchAll();for(let u of _)u.postMessage({type:"loaded-epub",data:{metadata:s,url:o,path:i}})}})})();
